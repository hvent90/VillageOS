# Discord Image Visibility Fix Implementation Plan

## Overview

Fix the critical issue where generated village images in Discord are only visible to the requesting user due to ephemeral message flags. For collaborative gameplay, images should be visible to all channel members.

## Current State Analysis

**Problem**: All Discord messages use `MessageFlags.Ephemeral`, making images private to the requesting user instead of visible to the entire channel.

**Impact**: Users cannot see village images generated by others, breaking collaborative farming simulator gameplay.

**Root Cause**: Ephemeral flags applied universally in:
- `src/services/discordBotService.ts` (lines 34, 135, 140, 148)
- `src/adapters/discordPlatformAdapter.ts` (lines 29, 38)

## Desired End State

- ✅ Image-containing messages are visible to all channel members
- ✅ Text-only responses remain ephemeral for user experience
- ✅ Error messages remain ephemeral for user experience
- ✅ No breaking changes to existing functionality

## What We're NOT Doing

- Not changing text-only message visibility
- Not modifying error message handling
- Not adding new features or configuration options
- Not changing the underlying image generation pipeline

## Implementation Approach

Simple, targeted fix: Remove ephemeral flags from messages containing images while preserving ephemeral behavior for text-only content.

## Phase 1: Core Visibility Fix

### Overview
Remove ephemeral flags from image-containing messages in Discord services.

### Changes Required:

#### 1. Discord Bot Service (`src/services/discordBotService.ts`)
**File**: `src/services/discordBotService.ts`
**Changes**: Remove ephemeral flags from async image results

```typescript
// Before (line 135):
await interaction.followUp({
  embeds: [embed],
  flags: MessageFlags.Ephemeral  // ❌ Remove this
});

// After:
await interaction.followUp({
  embeds: [embed]
  // No ephemeral flag - image visible to everyone
});
```

#### 2. Discord Platform Adapter (`src/adapters/discordPlatformAdapter.ts`)
**File**: `src/adapters/discordPlatformAdapter.ts`
**Changes**: Remove ephemeral flags from image results

```typescript
// Before (line 29):
await this.interaction.reply({...options, flags: MessageFlags.Ephemeral});

// After:
await this.interaction.reply(options);
// Remove ephemeral flag when mediaData is present
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compilation passes: `npm run build`
- [x] Linting passes: `npm run lint`
- [x] No runtime errors in Discord bot service

#### Manual Verification:
- [ ] Village create command generates visible image
- [ ] Village show command displays visible image
- [ ] Village me command shows visible character image
- [ ] Text-only responses remain ephemeral
- [ ] Error messages remain ephemeral

## Phase 2: Testing & Validation

### Overview
Test the visibility fix in a Discord environment.

### Changes Required:

#### 1. Test Commands
**File**: `test-configuration-endpoints.js`
**Changes**: Add visibility test cases

```javascript
// Add test for image visibility
console.log('Testing Discord image visibility...');
// Test commands that generate images
```

### Success Criteria:

#### Manual Verification:
- [ ] Images appear in channel history for all members
- [ ] Multiple users can see each other's generated images
- [ ] No regression in text-only message behavior
- [ ] Error handling still works correctly

## Testing Strategy

### Unit Tests:
- Test that image messages don't have ephemeral flags
- Test that text messages retain ephemeral flags
- Test error messages retain ephemeral flags

### Integration Tests:
- End-to-end Discord command testing
- Image generation and delivery verification

### Manual Testing Steps:
1. Run `/village create` and verify image is visible to all
2. Run `/village show` and verify image is visible to all
3. Run `/village me` and verify character image is visible to all
4. Test error scenarios to ensure they remain ephemeral
5. Test text-only commands to ensure they remain ephemeral

## Performance Considerations

- No performance impact expected
- Minimal code changes reduce risk of introducing bugs
- Maintains existing async processing for image generation

## Migration Notes

- No database changes required
- No breaking changes to existing API
- Backward compatible with existing Discord bot functionality

## References

- Original research: `thoughts/shared/research/2025-09-06_18-41-00_discord-image-generation-and-visibility-research.md`
- Discord bot service: `src/services/discordBotService.ts`
- Discord platform adapter: `src/adapters/discordPlatformAdapter.ts`